#!/usr/bin/env bash

set -eo pipefail

BACKENDS=(administrator reviewer reader identity)

stack_up() {
  docker compose up
}

stack_down() {
  docker compose down
}

stack_build() {
  docker compose build
  docker compose run --rm -v"$(pwd)/front-end:/app" front-end bash -c "npm install && chown -R $(id -u):$(id -g) node_modules"
}

poetry_relock() {
  for BACKEND in "${BACKENDS[@]}"; do
    docker compose run --rm be-$BACKEND bash -c "rm -f poetry.lock && poetry lock -vv"
  done
}

be_exec() {
  local ARGUMENTS=$1

  for BACKEND in "${BACKENDS[@]}"; do
    docker compose run --rm be-$BACKEND bash -c "${ARGUMENTS}"
  done
}

docker_image_prune() {
  # prune dangling images
  docker image prune -f
}

docker_compose_rm() {
  # remove one off containers
  docker compose rm
}

# we can probably do the rest in a single line by eval or something
execute() {
  local COMMAND=$1
  local ARGUMENTS=$(echo $2 | sed "s/^ *//" | sed "s/ *\$//")

  if [[ "${COMMAND}" == "up" ]]; then
    stack_up
  elif [[ "${COMMAND}" == "down" ]]; then
    stack_down
  elif [[ "${COMMAND}" == "build" ]]; then
    stack_build
  elif [[ "${COMMAND}" == "relock" ]]; then
    poetry_relock
  elif [[ "${COMMAND}" == "be-exec" ]]; then
    be_exec "${ARGUMENTS}"
  elif [[ "${COMMAND}" == "prune" ]]; then
    docker_image_prune
  elif [[ "${COMMAND}" == "rm" ]]; then
    docker_compose_rm
  else
    echo "unknown command ${COMMAND}"
    exit 1
  fi
}

execute "$1" "$2 $3 $4 $5 $6 $7 $8 $9"
