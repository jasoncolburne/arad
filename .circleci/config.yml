version: 2.1

x-docker-auth: &docker-auth
  username: $DOCKERHUB_USER
  password: $DOCKERHUB_ACCESS_TOKEN

x-install-python-test-dependencies: &install-python-test-dependencies
  name: Install test dependencies
  command: |
    cd /app
    poetry install --no-root --with test


x-black-steps: &black-steps
  - run: *install-python-test-dependencies
  - run:
      name: Blacken
      command: |
        cd /app
        . $(./activate)
        black --check .

x-pytest-steps: &pytest-steps
  - run: *install-python-test-dependencies
  - run:
      name: Pytest
      command: |
        cd /app
        . $(./activate)
        pytest .

x-pylint-steps: &pylint-steps
  - run: *install-python-test-dependencies
  - run:
      name: Pylint
      command: |
        cd /app
        . $(./activate)
        find . -maxdepth 1 -type d -not -name '.*' | xargs pylint

x-mypy-steps: &mypy-steps
  - run: *install-python-test-dependencies
  - run:
      name: Mypy
      command: |
        cd /app
        . $(./activate)
        mypy --install-types --non-interactive .


jobs:
  build-images:
    resource_class: large
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.14
      - run:
          name: Update package manager
          command: sudo apt-get update
      - run:
          name: Install dependencies
          command: sudo apt-get -y install rsync
      - run:
          name: Sync common code
          command: ./scripts/sync
      - run:
          name: Build images from docker-compose.yml
          command: docker compose -f docker-compose.build.yml build
      - run:
          name: Create front-end image from base
          command: |
            docker compose -f docker-compose.build.yml up -d front-end-base
            docker compose -f docker-compose.build.yml cp front-end-base:/app/build front-end-nginx
            docker compose -f docker-compose.build.yml down
            docker build -t project_front-end:latest front-end-nginx
      - run:
          name: Tag images
          command: |
            IMAGES=(front-end e2e-client identity reader reviewer administrator core api)
            for IMAGE in "${IMAGES[@]}"; do
              LATEST_TAG="${IMAGE}-${CIRCLE_BRANCH}-latest"
              HASH_TAG="${IMAGE}-${CIRCLE_BRANCH}-$(git rev-parse --short HEAD)"

              docker tag "project_${IMAGE}:latest" "${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:${LATEST_TAG}"
              docker tag "project_${IMAGE}:latest" "${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:${HASH_TAG}"
            done
      - run:
          name: Login to DockerHub
          command: docker login -u "${DOCKERHUB_USER}" -p "${DOCKERHUB_ACCESS_TOKEN}"
      - run:
          name: Push images
          command: |
            IMAGES=(front-end e2e-client identity reader reviewer administrator core api)
            for IMAGE in "${IMAGES[@]}"; do
              LATEST_TAG="${IMAGE}-${CIRCLE_BRANCH}-latest"
              HASH_TAG="${IMAGE}-${CIRCLE_BRANCH}-$(git rev-parse --short HEAD)"

              docker push "${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:${LATEST_TAG}" --quiet
              docker push "${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:${HASH_TAG}" --quiet
            done

  end-to-end:
    resource_class: large
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.14
      - run:
          name: Update package manager
          command: sudo apt-get update
      - run:
          name: Install dependencies
          command: sudo apt-get -y install rsync git
      - run:
          name: Sync common code
          command: ./scripts/sync
      - run:
          name: Login to DockerHub
          command: docker login -u "${DOCKERHUB_USER}" -p "${DOCKERHUB_ACCESS_TOKEN}"
      - run:
          name: Create .env file
          command: |
            echo "DOCKERHUB_USER=${DOCKERHUB_USER}" > .env
            echo "CIRCLE_PROJECT_REPONAME=${CIRCLE_PROJECT_REPONAME}" >> .env
            echo "CIRCLE_BRANCH=${CIRCLE_BRANCH}" >> .env
      - run:
          name: Provision Database
          command: ./scripts/provision-ci-database
      - run:
          name: End to End Tests
          command: |
            docker compose -f docker-compose.ci.yml up -d \
              database \
              cache \
              identity \
              reader \
              reviewer \
              administrator \
              api \
              front-end
            docker compose -f docker-compose.ci.yml build e2e-client
            docker compose -f docker-compose.ci.yml run --rm e2e-client bash -c "yarn cypress:ci"

  black-identity:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:identity-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *black-steps

  black-administrator:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:administrator-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *black-steps

  black-reviewer:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reviewer-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *black-steps

  black-reader:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reader-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *black-steps

  black-core:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:core-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *black-steps

  pytest-identity:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:identity-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    environment:
      ACCESS_TOKEN_PRIVATE_KEY_PEM: |
        -----BEGIN EC PRIVATE KEY-----
        MHcCAQEEIPDn6E30e3lwXXnW1GyYYH942x0OiU/lRhYKYh9IJReaoAoGCCqGSM49
        AwEHoUQDQgAEnoH4lyjW4T0uUFbAYRL1G/3dxF1Mkak4CYTwDU8lSubpkIKXFqo7
        KtsWIycbTKbfLm2IdwNXDOO346u4OhCaBg==
        -----END EC PRIVATE KEY-----
      DEFAULT_ADMIN_EMAIL: admin@domain.org
    steps: *pytest-steps

  pytest-administrator:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:administrator-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pytest-steps

  pytest-reviewer:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reviewer-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pytest-steps

  pytest-reader:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reader-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pytest-steps

  pytest-core:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:core-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    environment:
      ACCESS_TOKEN_PUBLIC_KEY_PEM: |
        -----BEGIN PUBLIC KEY-----
        MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEnoH4lyjW4T0uUFbAYRL1G/3dxF1M
        kak4CYTwDU8lSubpkIKXFqo7KtsWIycbTKbfLm2IdwNXDOO346u4OhCaBg==
        -----END PUBLIC KEY-----
    steps: *pytest-steps

  pylint-identity:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:identity-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pylint-steps

  pylint-administrator:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:administrator-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pylint-steps

  pylint-reviewer:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reviewer-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pylint-steps

  pylint-reader:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reader-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pylint-steps

  pylint-core:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:core-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *pylint-steps

  mypy-identity:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:identity-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *mypy-steps

  mypy-administrator:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:administrator-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *mypy-steps

  mypy-reviewer:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reviewer-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *mypy-steps

  mypy-reader:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:reader-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *mypy-steps

  mypy-core:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:core-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps: *mypy-steps

  eslint-front-end:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:front-end-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps:
      - run:
          name: Eslint
          command: |
            cd /app
            yarn run eslint --max-warnings=0 .

  prettier-front-end:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:front-end-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps:
      - run:
          name: Prettier
          command: |
            cd /app
            yarn run prettier --check src

  typecheck-front-end:
    resource_class: small
    docker:
      - image: ${DOCKERHUB_USER}/${CIRCLE_PROJECT_REPONAME}:front-end-${CIRCLE_BRANCH}-latest
        auth: *docker-auth
    steps:
      - run:
          name: Typecheck
          command: |
            cd /app
            yarn run tsc --strict



workflows:
  everything:
    jobs:
      - hold:
          type: approval
      - build-images:
          requires:
            - hold
      - end-to-end:
          requires:
            - build-images
      - black-identity:
          requires:
            - build-images
      - black-administrator:
          requires:
            - build-images
      - black-reviewer:
          requires:
            - build-images
      - black-reader:
          requires:
            - build-images
      - black-core:
          requires:
            - build-images
      - pytest-identity:
          requires:
            - build-images
      - pytest-administrator:
          requires:
            - build-images
      - pytest-reviewer:
          requires:
            - build-images
      - pytest-reader:
          requires:
            - build-images
      - pytest-core:
          requires:
            - build-images
      - pylint-identity:
          requires:
            - build-images
      - pylint-administrator:
          requires:
            - build-images
      - pylint-reviewer:
          requires:
            - build-images
      - pylint-reader:
          requires:
            - build-images
      - pylint-core:
          requires:
            - build-images
      - mypy-identity:
          requires:
            - build-images
      - mypy-administrator:
          requires:
            - build-images
      - mypy-reviewer:
          requires:
            - build-images
      - mypy-reader:
          requires:
            - build-images
      - mypy-core:
          requires:
            - build-images
      - typecheck-front-end:
          requires:
            - build-images
      - eslint-front-end:
          requires:
            - build-images
      - prettier-front-end:
          requires:
            - build-images
