[[- define "upstream_consul" -]]
data = <<EOH
upstream [[ . ]] {
{{- range service [[ (print . "-service") | quote ]] }}
  server 10.1.0.1:{{ .Port }};
{{- end -}}
{{- $SERVICE_COUNT := len (service [[ (print . "-service") | quote ]]) -}}
{{- if (gt $SERVICE_COUNT 0) }}
  keepalive {{ multiply $SERVICE_COUNT 2 }};
{{ end -}}
}
EOH
[[ end -]]
